# 典型案例分析

本文档展示10个关键测试案例，说明不同方法的优劣势。

---

## ✅ Baseline 胜出案例（3个）

### 案例1：品类查询 - 包子种类最多

**问题**：哪个档口的包子种类最多？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| **实验1 (Baseline)** | ✅ 一号餐厅（42号档口）提供12种包子：鲜肉包、玉米鲜肉包、香菇鲜肉包... | 19.15s | **完整** |
| 实验2 (CR) | ⚠️ 一号餐厅的包子种类最多（但档口号错误） | 5.43s | 部分正确 |
| 实验3 (Jieba) | ✅ 香港九龙包（42号档口）+ 12种包子列表 | 20.40s | **完整** |

**分析**：
- Baseline提供了**完整的信息**（档口名+编号+12种包子列表）
- CR虽然快但**信息丢失**（只给了概括，没有详细列表）
- Jieba恢复了完整性

**结论**：对于需要**详细信息**的查询，Baseline更可靠

---

### 案例2：档口名称 - 10号窗口是什么

**问题**：二号餐厅10号窗口是什么档口？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| **实验1 (Baseline)** | ✅ 二十、民族风味（10号） | 4.46s | **完全正确** |
| 实验2 (CR) | ❌ 无法确定 | 6.89s | **完全错误** |
| 实验3 (Jieba) | ✅ 是民族风味档口 | 2.73s | 完全正确 |

**分析**：
- Baseline准确回答了档口名称
- CR在生成上下文时**丢失了关键信息**（档口名称被省略）
- Jieba最快且准确

**结论**：CR可能在信息压缩时丢失关键细节

---

### 案例3：多窗口查询 - 面条窗口

**问题**：想吃面条，有哪些窗口？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| **实验1 (Baseline)** | ✅ 窗口4、5、16、18、26、27以及二号餐厅 | 7.92s | **详细完整** |
| 实验2 (CR) | ⚠️ 窗口2、13、19、30 | 7.48s | 部分正确 |
| 实验3 (Jieba) | ⚠️ 天下好面（4号）、兰州拉面（5号） | 7.56s | 部分正确 |

**分析**：
- Baseline列举了**所有**面条窗口（7个）
- CR和Jieba都只返回了**部分**窗口
- Baseline的信息覆盖最全面

**结论**：对于"列举所有"类查询，Baseline检索范围更广

---

## ✅ CR 胜出案例（3个）

### 案例4：消歧查询 - 天津包子位置 ⭐

**问题**：天津包子档口在几号窗口？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| 实验1 (Baseline) | ❌ 42号窗口（错误，混淆为香港九龙包） | 4.66s | **完全错误** |
| **实验2 (CR)** | ✅ **21号窗口** | 4.67s | **完全正确** |
| 实验3 (Jieba) | ❌ 42号窗口（同样错误） | 5.42s | 完全错误 |

**分析**：
- Baseline和Jieba都将"天津包子"误认为"香港九龙包"
- CR通过上下文前缀成功区分了两个档口：
  ```
  CR生成的上下文：
  "天津包子档口（21号）位于一号餐厅一楼"
  "香港九龙包档口（42号）位于一号餐厅一楼"
  ```
- **这是CR最大的优势案例**

**结论**：CR在**语义消歧**上表现出色（+100%准确率）

---

### 案例5：价格查询 - 一号餐厅2元粥

**问题**：一号餐厅有哪些2元的粥？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| 实验1 (Baseline) | ⚠️ 列举了9种，但混入了非2元商品 | 11.80s | 部分正确 |
| **实验2 (CR)** | ✅ 准确区分了"好粥道"和"我爱我粥"的2元粥品 | 23.83s | **完全正确** |
| 实验3 (Jieba) | ✅ 小米南瓜粥、清火绿豆粥、紫薯黑米粥... | 10.71s | 完全正确 |

**分析**：
- Baseline混淆了不同档口的商品
- CR通过上下文明确了**档口归属**
- Jieba速度最快且准确

**结论**：CR在需要**区分来源**的查询中有优势

---

### 案例6：对比查询 - 包子价格对比

**问题**：天津包子和香港九龙包，哪个更便宜？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| 实验1 (Baseline) | ✅ 天津包子2元，香港九龙包4元/笼，天津更便宜 | 10.78s | 完全正确 |
| **实验2 (CR)** | ✅ 天津包子的品类有2元的，香港九龙包4元 | 8.77s | **完全正确** |
| 实验3 (Jieba) | ✅ 天津包子有2元品类，香港九龙包4元 | 9.92s | 完全正确 |

**分析**：
- 所有方法都正确回答
- CR耗时最短（8.77s）
- 上下文帮助快速定位到价格对比信息

**结论**：CR在**对比类查询**中效率更高

---

## ❌ 全部失败案例（4个）

### 案例7：餐厅窗口查询

**问题**：一号餐厅有哪些窗口或档口？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| 实验1 (Baseline) | ❌ 只提到Window 14 | 24.42s | **失败** |
| 实验2 (CR) | ❌ 明确说"检索到的是二号餐厅" | 24.25s | **失败** |
| 实验3 (Jieba) | ❌ "提供的信息是二号餐厅" | 22.02s | **失败** |

**为什么失败？**
1. **数据分块问题**：一号餐厅的档口信息可能被分散到多个chunk
2. **检索相关性差**：问"一号餐厅"却检索到"二号餐厅"的chunk
3. **缺少全局视图**：向量检索无法聚合所有相关chunk

**改进方向**：
- 添加Reranking重新排序chunk
- 改进分块策略（按餐厅分组）
- 使用元数据过滤（先筛选"一号餐厅"的chunk）

---

### 案例8：1.5元食品窗口

**问题**：二号餐厅哪些窗口有1.5元的食品？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| 实验1 (Baseline) | ⚠️ Window 29（但不完整） | 6.78s | **部分正确** |
| 实验2 (CR) | ⚠️ Window 16有1.5元品类（但未列举） | 6.76s | **部分正确** |
| 实验3 (Jieba) | ⚠️ 只说Window 8有1.5元商品 | 5.99s | **部分正确** |

**为什么失败？**
1. **检索范围不足**：只返回了部分窗口，漏掉了其他有1.5元商品的窗口
2. **信息聚合失败**：每个窗口的1.5元商品分散在不同chunk中
3. **Top-K限制**：similarity_top_k=12可能不够

**改进方向**：
- 增加Top-K到20-30
- 添加价格过滤器（metadata filtering）
- 多轮检索聚合

---

### 案例9：餐厅档口数量对比

**问题**：一号餐厅和二号餐厅，哪个档口更多？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| 实验1 (Baseline) | ❌ 无法确定 | 8.45s | **失败** |
| 实验2 (CR) | ❌ 无法确定 | 13.03s | **失败** |
| 实验3 (Jieba) | ❌ "二号餐厅有多个档口...Window 10、4、3、2" | 8.13s | **失败** |

**为什么失败？**
1. **需要统计能力**：RAG无法自动统计档口数量
2. **需要全局信息**：必须看到所有档口才能对比
3. **数据格式问题**：档口编号分散在文本各处

**改进方向**：
- 预先提取档口元数据（档口名→编号→餐厅）
- 使用知识图谱进行结构化查询
- 或直接用SQL数据库

---

### 案例10：二号餐厅一楼档口

**问题**：二号餐厅一楼有哪些档口？

| 方法 | 回答 | 耗时 | 评分 |
|-----|------|------|------|
| 实验1 (Baseline) | ⚠️ Window 10、4、30、29、3（部分） | 9.82s | **部分正确** |
| 实验2 (CR) | ❌ 只描述了菜品，没提档口编号 | 19.43s | **失败** |
| 实验3 (Jieba) | ⚠️ Window 10、4、3、2、1（部分） | 7.18s | **部分正确** |

**为什么失败？**
1. **列举不完整**：二号餐厅一楼实际有30+个窗口，但只返回了5个
2. **CR信息丢失**：生成的上下文忽略了档口编号
3. **检索范围限制**：Top-12无法覆盖30+个档口

**改进方向**：
- 元数据标注（楼层、餐厅）
- 增加检索数量
- 结构化预处理

---

## 📊 失败原因汇总

| 失败类型 | 占比 | 根本原因 | 解决方案 |
|---------|------|---------|---------|
| **检索范围不足** | 50% | Top-K太小，无法覆盖所有相关chunk | 增加Top-K + Reranking |
| **信息聚合失败** | 30% | 信息分散在多个chunk，LLM无法整合 | 改进分块策略 + 元数据 |
| **CR信息丢失** | 10% | 上下文生成时省略了关键细节 | 更大的LLM模型 |
| **数据格式问题** | 10% | 结构化列表缺少自然语境 | **换数据集** |

---

## 🎓 学术价值

### 关键洞察

1. **CR的双刃剑**：
   - ✅ 消歧能力+100%（天津包子案例）
   - ❌ 信息丢失导致-100%（档口名称案例）

2. **结构化数据的挑战**：
   - 列表数据缺少语境，限制了CR的发挥
   - 需要用**元数据 + 传统索引**而非纯NLP方法

3. **检索策略的重要性**：
   - jieba分词提升混合检索速度19.9%
   - 但无法解决数据本身的结构化问题

### 论文方向

> **《When Does Contextual Retrieval Work? A Case Study on Structured vs. Natural Language Data》**

---

## 💡 改进建议

### 短期优化
1. 添加Reranking（bge-reranker-v2-m3）
2. 增加Top-K到20-30
3. 添加元数据过滤（餐厅、楼层）

### 长期方向
1. **换数据集**：使用自然语言文本（评论、文章）
2. **混合架构**：结构化数据用数据库，文本数据用RAG
3. **动态CR**：根据查询类型决定是否启用CR

---

**总结**：本项目清晰展示了CR在不同场景下的表现，为RAG系统设计提供了宝贵参考。
