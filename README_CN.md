# ç»“æ„åŒ–æ•°æ®çš„ä¸Šä¸‹æ–‡æ£€ç´¢ï¼šå¯å¤ç°å®éªŒ

**[English](README.md) | [ç®€ä½“ä¸­æ–‡](README_CN.md)**

[![Python 3.11+](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Reproducible](https://img.shields.io/badge/reproducible-yes-green.svg)](https://github.com/roclee2692/contextual-retrieval-by-anthropic)

> **æ ¸å¿ƒå‘ç°**ï¼šåœ¨å¤ç°äº† Anthropic çš„ Contextual Retrieval ç®—æ³•åï¼Œæˆ‘ä»¬å¼•å…¥äº†**å‚ç›´é¢†åŸŸï¼ˆé˜²æ´ªï¼‰çŸ¥è¯†å›¾è°±**è¿›è¡Œå¯¹æ¯”å®éªŒã€‚å‘ç° CR åœ¨ç»“æ„åŒ–æ•°æ®ä¸Šå­˜åœ¨â€œåŒåˆƒå‰‘â€æ•ˆåº”ï¼Œè€ŒçŸ¥è¯†å›¾è°±èƒ½æ˜¾è‘—å¼¥è¡¥å…¶åœ¨é€»è¾‘æ¨ç†ä¸Šçš„çŸ­æ¿ã€‚

---

## ğŸ¯ å®éªŒæ¶æ„

æœ¬é¡¹ç›®å°†ç ”ç©¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ŒåŒ…å« **5 ç»„å¯¹æ¯”å®éªŒ**ï¼Œæ—¨åœ¨å…¨é¢è¯„ä¼° RAG æŠ€æœ¯åœ¨ä¸åŒæ•°æ®å½¢æ€ä¸‹çš„è¡¨ç°ï¼š

### ç¬¬ä¸€é˜¶æ®µï¼šç»“æ„åŒ–åˆ—è¡¨æ•°æ®ï¼ˆé£Ÿå ‚èœå•ï¼‰
> éªŒè¯ CR åœ¨**éè‡ªç„¶è¯­è¨€æ–‡æœ¬**ä¸Šçš„å±€é™æ€§ä¸ä¼˜åŠ¿ã€‚

| å®éªŒç¼–å· | æ–¹æ³• | æ ¸å¿ƒæŠ€æœ¯ | é€‚ç”¨æ•°æ® |
|---|---|---|---|
| **Exp 1** | Baseline RAG | å‘é‡æ£€ç´¢ (bge-small-zh) + BM25 | åˆ—è¡¨ (List) |
| **Exp 2** | CR Enhanced | LLM ç”Ÿæˆä¸Šä¸‹æ–‡å‰ç¼€ + å‘é‡ + BM25 | åˆ—è¡¨ (List) |
| **Exp 3** | Jieba + Simple KG | ç»“å·´åˆ†è¯ + NetworkX ç®€å•å›¾è°± | åˆ—è¡¨ (List) |

### ç¬¬äºŒé˜¶æ®µ:éç»“æ„åŒ–é¢†åŸŸæ•°æ®(é˜²æ´ªé¢„æ¡ˆ)
> éªŒè¯ Baselineã€CR å’Œ KG åœ¨**å‚ç›´é¢†åŸŸå¤æ‚æ–‡æœ¬**ä¸Šçš„æ¨ç†èƒ½åŠ›å¯¹æ¯”ã€‚

| å®éªŒç¼–å· | æ–¹æ³• | æ ¸å¿ƒæŠ€æœ¯ | é€‚ç”¨æ•°æ® |
|---|---|---|---|
| **Exp 4** | Baseline (Flood) | å‘é‡ + BM25(æ— ä¸Šä¸‹æ–‡å¢å¼º) | æ–‡æœ¬ (Text) |
| **Exp 5** | CR (Flood) | ä¸Šä¸‹æ–‡æ£€ç´¢(LLM ç”Ÿæˆä¸Šä¸‹æ–‡å‰ç¼€) | æ–‡æœ¬ (Text) |
| **Exp 6** | Deep KG (Flood) | LlamaIndex çŸ¥è¯†å›¾è°± + å›¾æ¨ç† | æ–‡æœ¬ (Text) |

---

## ğŸ“Š Phase 1: é£Ÿå ‚å®éªŒè¯¦ç»†ç»“æœ

### å®éªŒé…ç½®å¯¹æ¯”

| å®éªŒ | å‘é‡æ£€ç´¢ | BM25åˆ†è¯å™¨ | ä¸Šä¸‹æ–‡å¢å¼º | çŸ¥è¯†å›¾è°± |
|------|---------|-----------|-----------|----------|
| **å®éªŒ1: Baseline** | âœ… bge-small-zh | âŒ é»˜è®¤è‹±æ–‡åˆ†è¯ | âŒ | âŒ |
| **å®éªŒ2: CRå¢å¼º** | âœ… bge-small-zh | âŒ é»˜è®¤è‹±æ–‡åˆ†è¯ | âœ… CRå‰ç¼€ | âŒ |
| **å®éªŒ3: ç»“å·´+KG** | âœ… bge-small-zh | âœ… jieba + "åŒ…"â†’"åŒ…å­" | âŒ | âœ… NetworkX |

### æ€§èƒ½ä¸å‡†ç¡®ç‡å¯¹æ¯”

| æŒ‡æ ‡ | å®éªŒ1 (Baseline) | å®éªŒ2 (CR) | å®éªŒ3 (ç»“å·´+KG) | æœ€ä½³ |
|------|-----------------|-----------|----------------|------|
| **å¹³å‡å“åº”æ—¶é—´** | 12.79ç§’ | 13.64ç§’ (+6.7%) | **10.13ç§’** âš¡ | **å®éªŒ3** |
| **æ··åˆæ£€ç´¢åŠ é€Ÿæ¯”** | 9.9% | 8.5% | **19.9%** | **å®éªŒ3** |
| **ä»·æ ¼æŸ¥è¯¢å‡†ç¡®ç‡** | 75% | **100%** âœ… | **100%** âœ… | **å®éªŒ2/3** |
| **å“ç±»æŸ¥è¯¢å‡†ç¡®ç‡** | **100%** âœ… | 83% | 83% | **å®éªŒ1** |
| **ä½ç½®æŸ¥è¯¢å‡†ç¡®ç‡** | 75% | **75%** | 50% | **å®éªŒ1/2** |
| **ä¿¡æ¯å®Œæ•´æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | **å®éªŒ1/3** |

### ğŸ” æ ¸å¿ƒå‘ç°ï¼šCRçš„åŒåˆƒå‰‘æ•ˆåº”

#### âœ… CRæˆåŠŸæ¡ˆä¾‹ï¼ˆè¯­ä¹‰æ¶ˆæ­§ï¼‰
**Q8: å¤©æ´¥åŒ…å­ä½ç½®æŸ¥è¯¢**
- **å®éªŒ1 (Baseline)**: 0% - ä¸"é¦™æ¸¯ä¹é¾™åŒ…"æ··æ·†
- **å®éªŒ2 (CR)**: **100%** âœ… - æˆåŠŸè¯†åˆ«æ­£ç¡®æ¡£å£
- **æ ¹æœ¬åŸå› **: CRä¸Šä¸‹æ–‡å‰ç¼€æ¶ˆé™¤äº†è¯­ä¹‰æ­§ä¹‰

**Q16: 2å…ƒç²¥æŸ¥è¯¢**
- **å®éªŒ1**: 60% - éƒ¨åˆ†åŒ¹é…
- **å®éªŒ2**: **100%** âœ… - ç²¾å‡†åŒ¹é…ä»·æ ¼
- **å®éªŒ3**: 85% - è‰¯å¥½ä½†éå®Œç¾

#### âŒ CRå¤±è´¥æ¡ˆä¾‹ï¼ˆä¿¡æ¯ä¸¢å¤±ï¼‰
**Q9: æ¡£å£åç§°æŸ¥è¯¢**
- **å®éªŒ1 (Baseline)**: **100%** âœ… - åˆ—å‡ºæ‰€æœ‰é¢æ¡çª—å£
- **å®éªŒ2 (CR)**: **0%** âŒ - ä¸Šä¸‹æ–‡ç”Ÿæˆæ—¶ä¸¢å¤±æ¡£å£åç§°
- **åŸå› **: LLMæ€»ç»“å‹ç¼©å¯¼è‡´å…³é”®ç»†èŠ‚ä¸¢å¤±

**Q15: åŒ…å­ç§ç±»æŸ¥è¯¢**
- **å®éªŒ1**: å®Œæ•´åˆ—è¡¨ï¼ˆ12ç§ï¼‰
- **å®éªŒ2**: ä»…æ¦‚æ‹¬æ€§æè¿°
- **å®éªŒ3**: **è¯¦ç»†åˆ—ä¸¾** âœ…

### ğŸ’¡ å…³é”®å­¦æœ¯æ´å¯Ÿ

#### 1. CRåœ¨ä¸­æ–‡RAGä¸­ä¸æ˜¯æ™®é€‚æ€§æ”¹è¿›
> "CRç®—æ³•æ˜¯é’ˆå¯¹ç‰¹å®šæŸ¥è¯¢ç±»å‹çš„ç²¾å‡†ä¼˜åŒ–å·¥å…·ï¼Œè€Œéä¸‡èƒ½å¢å¼ºã€‚"

**è¯æ®**:
- âœ… **æ¶ˆæ­§ç±»æŸ¥è¯¢**: +100% (å¤©æ´¥åŒ…å­)
- âŒ **æšä¸¾ç±»æŸ¥è¯¢**: -100% (æ¡£å£åç§°)
- âš ï¸ **ä¿¡æ¯å¯†åº¦**: ä¸Šä¸‹æ–‡å‹ç¼©å¯¼è‡´ç»†èŠ‚ä¸¢å¤±

#### 2. æ··åˆæ£€ç´¢æ€§èƒ½ä¼˜åŒ–æ›²çº¿
```
å“åº”æ—¶é—´ä¼˜åŒ–ï¼š
å®éªŒ1: 11.52ç§’ (åŸºçº¿)
å®éªŒ2: 12.48ç§’ (+8.3% â†—ï¸ CRå¢åŠ å»¶è¿Ÿ)
å®éªŒ3: 10.13ç§’ (-12.1% â†˜ï¸ ç»“å·´+ä¼˜åŒ–ç´¢å¼•)
```

**å‘ç°**: BM25+å‘é‡æ··åˆæ£€ç´¢æ¯”çº¯å‘é‡å¿« **19.9%**ï¼ˆå®éªŒ3ï¼‰

#### 3. ä¸­æ–‡åˆ†è¯å¯¹BM25æ•ˆæœçš„å½±å“

| åˆ†è¯ç­–ç•¥ | Q8å¤©æ´¥åŒ…å­ | Q16ä¸€å·2å…ƒç²¥ | å¹³å‡å‡†ç¡®ç‡ |
|---------|-----------|------------|----------|
| æ— jiebaï¼ˆå†å²ï¼‰ | 0% | 60% | ~30% |
| jieba+"åŒ…"æ‰©å±• | 50%ï¼ˆæ··åˆï¼‰ | 85% | ~67.5% |
| jieba+CRä¸Šä¸‹æ–‡ | **100%** | **100%** | **100%** |

**å­¦æœ¯ä»·å€¼**: é¦–æ¬¡é‡åŒ–éªŒè¯"jiebaåˆ†è¯ + CRä¸Šä¸‹æ–‡å¢å¼º"åœ¨ä¸­æ–‡BM25æ£€ç´¢ä¸­çš„ååŒæ•ˆåº”ã€‚

### ğŸ† ç»¼åˆæ’å

1. ğŸ¥‡ **å®éªŒ3 (ç»“å·´+KG)** - é€Ÿåº¦æœ€å¿«ï¼Œæ€§èƒ½æœ€å‡è¡¡
2. ğŸ¥ˆ **å®éªŒ1 (Baseline)** - å“ç±»æŸ¥è¯¢æœ€å‡†ç¡®ï¼Œä¿¡æ¯æœ€å®Œæ•´
3. ğŸ¥‰ **å®éªŒ2 (CR)** - æ¶ˆæ­§èƒ½åŠ›æœ€å¼ºï¼Œä½†ä¿¡æ¯ä¸¢å¤±æ˜æ˜¾

---

## ğŸ†• Phase 2: é˜²æ´ªé¢„æ¡ˆä¸‰ç»„å¯¹æ¯”å®éªŒ(æ–°å¢)

åœ¨ Phase 1 çš„åŸºç¡€ä¸Š,æˆ‘ä»¬åœ¨ **é˜²æ´ªåº”æ€¥é¢„æ¡ˆ** å‚ç›´é¢†åŸŸæ•°æ®ä¸Šè¿›è¡Œäº†å®Œæ•´çš„ä¸‰ç»„å¯¹æ¯”å®éªŒã€‚
*è¯¦ç»†å¯¹æ¯”æŠ¥å‘Šè§ `results/phase2_complete_comparison.md`*

### å®éªŒè®¾è®¡
| å®éªŒ | è¯´æ˜ | è„šæœ¬ |
|---|---|---|
| **Exp 4: Baseline** | çº¯å‘é‡+BM25æ£€ç´¢(æ— CR) | `scripts/phase2_three_way_comparison.py` |
| **Exp 5: CR Enhanced** | å¸¦ä¸Šä¸‹æ–‡å¢å¼ºçš„æ£€ç´¢ | `scripts/phase2_three_way_comparison.py` |
| **Exp 6: Deep KG** | çŸ¥è¯†å›¾è°±æ¨ç†æ£€ç´¢ | `scripts/create_knowledge_graph.py` + `scripts/phase2_three_way_comparison.py` |

### æ€§èƒ½ä¸å‡†ç¡®ç‡å¯¹æ¯” (2026/01/24 ç§‘å­¦ä¿®æ­£ç‰ˆ)

**é‡è¦æ›´æ–°**: åœ¨ä¿®æ­£äº†å®éªŒå¯¹ç…§ç»„çš„å…¬å¹³æ€§ï¼ˆBaseline ä¸ CR å‡é‡‡ç”¨ç›¸åŒçš„ ChromaDB æŒä¹…åŒ–ç»“æ„ä¸ Jieba åˆ†è¯å‚æ•°ï¼‰åï¼Œæˆ‘ä»¬å¾—åˆ°äº†æ–°çš„ç»“è®ºï¼š

| æŒ‡æ ‡ | Baseline | CRå¢å¼º | Knowledge Graph |
|------|----------|--------|----------------|
| **å¹³å‡æ£€ç´¢å¾—åˆ†** | **0.493** | **0.495** | 1000.0* |
| **ç»“è®º** | **åŸºå‡†ç¨³å¥** | **æ— æ˜¾è‘—å·®å¼‚** | **ä¸å¯ç”¨** |

*\*KGå¾—åˆ†=1000.0ä¸ºæ¡†æ¶é»˜è®¤é«˜åˆ†ï¼Œå®é™…å†…å®¹ç›¸å…³æ€§ä½*

### ğŸ” æ ¸å¿ƒå‘ç°ï¼šåœ¨ç»“æ„åŒ–å…¬æ–‡ä¸­ CR å¤±æ•ˆ

#### 1. CR ä¸ Baseline å½¢æˆâ€œå¹³å±€â€
- **æ•°æ®**: 0.493 vs 0.495 (å·®è· 0.4%)
- **åŸå› **: ã€Šé˜²æ´ªé¢„æ¡ˆã€‹æœ¬èº«å…·å¤‡æå¼ºçš„ç»“æ„æ€§ï¼ˆç« èŠ‚ã€æ¡æ¬¾ã€ç¼–å·ï¼‰ã€‚ç›¸æ¯”äº Phase 1 çš„ç¢ç‰‡åŒ–èœå•æ•°æ®ï¼ŒåŸå§‹æ–‡æ¡£å·²ç»æä¾›äº†è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ã€‚LLM ç”Ÿæˆçš„é¢å¤– Contextï¼ˆå¦‚â€œæœ¬æ®µè½æè¿°äº†...â€ï¼‰åè€Œæˆä¸ºäº†ä¿¡æ¯å™ªå£°ã€‚

#### 2. ä¸­æ–‡åˆ†è¯ (Tokenization) çš„éšå½¢ç“¶é¢ˆ
- æˆ‘ä»¬å‡è®¾ CR å¤±æ•ˆæ˜¯å› ä¸º Jieba åˆ†è¯åœ¨ BM25 ä¸­ç¼ºå¤±ï¼Œä½†åœ¨å¼ºåˆ¶æ³¨å…¥ Jieba åˆ†è¯å‚æ•°åï¼Œä¸¤è€…å¾—åˆ†ä¾ç„¶æŒå¹³ã€‚
- è¿™è¡¨æ˜ï¼Œå¯¹äº**é«˜åº¦è‡ªåŒ…å«çš„å…¬æ–‡æ–‡æ¡£**ï¼Œæ£€ç´¢æ€§èƒ½çš„ç“¶é¢ˆä¸åœ¨äºä¸Šä¸‹æ–‡ç¼ºå¤±ï¼Œè€Œåœ¨äºè¯­ä¹‰åŒ¹é…çš„ç²¾åº¦ã€‚å‘é‡æ£€ç´¢å·²ç»åšå¾—è¶³å¤Ÿå¥½ï¼ŒCR æ— æ³•åœ¨æ­¤åŸºç¡€ä¸Šæä¾›è¾¹é™…å¢ç›Šã€‚

#### 3. Knowledge Graph çš„è™šå‡ç¹è£
- KG ç»„è™½ç„¶å¾—åˆ†é«˜ï¼ˆ1000ï¼‰ï¼Œä½†æ£€ç´¢ç»“æœå¤šä¸ºâ€œç›®å½•â€æˆ–â€œæ ‡é¢˜â€ï¼Œç¼ºä¹å®è´¨å†…å®¹ã€‚è¿™è¯æ˜äº†åœ¨æ²¡æœ‰ç‰¹å®š Schema çº¦æŸçš„æƒ…å†µä¸‹ï¼Œé€šç”¨çš„çŸ¥è¯†å›¾è°±æŠ½å–æ–¹æ¡ˆåœ¨å‚ç›´é¢†åŸŸå®Œå…¨ä¸å¯ç”¨ã€‚

### ğŸ† ç»¼åˆæ’åï¼ˆé˜¶æ®µäºŒï¼‰

1. ğŸ¥‡ **Baseline (å¹¶åˆ—)** - ç®€å•ã€å¿«é€Ÿã€ç¨³å¥
2. ğŸ¥‡ **CRå¢å¼º (å¹¶åˆ—)** - æˆæœ¬æ›´é«˜ï¼Œä½†æ•ˆæœæ— å·®å¼‚
3. ğŸ¥‰ **Knowledge Graph** - æ…¢ä¸”æ•ˆæœå·®

---
## ğŸ”„ ç³»ç»Ÿæµç¨‹å›¾ (System Pipeline)

```mermaid
graph LR
    A[PDF æ•°æ®] --> B[æ–‡æœ¬åˆ‡ç‰‡]
    B --> C{å¯ç”¨ CR?}
    C -->|æ˜¯| D[LLM ç”Ÿæˆä¸Šä¸‹æ–‡]
    C -->|å¦| E[åŸå§‹åˆ‡ç‰‡]
    D --> F[æ‹¼æ¥ä¸Šä¸‹æ–‡ + åŸæ–‡]
    E --> G[Embedding å‘é‡åŒ–]
    F --> G
    G --> H[å‘é‡æ•°æ®åº“ ChromaDB]
    
    subgraph æ··åˆæ£€ç´¢
    B --> I{å¯ç”¨ç»“å·´?}
    I -->|æ˜¯| J["ä¸­æ–‡åˆ†è¯<br/>(BM25)"]
    I -->|å¦| K[é»˜è®¤åˆ†è¯]
    J --> L[BM25 ç´¢å¼•]
    K --> L
    end

    subgraph "Phase 2: çŸ¥è¯†å›¾è°±"
    B --> M[å®ä½“æŠ½å–]
    M --> N[å›¾è°±æ„å»º Graph Store]
    N --> O[å›¾è°±æ¨ç†æŸ¥è¯¢]
    end
    
    H -.-> P[æœ€ç»ˆæ··åˆæ£€ç´¢]
    L -.-> P
    O -.-> P
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡
- Python 3.11+
- [Ollama](https://ollama.com/download) å·²å®‰è£…
- `gemma3:12b` (é—®ç­”) å’Œ `gemma2:2b` (ä¸Šä¸‹æ–‡ç”Ÿæˆ)

### 1. å®‰è£…ä¾èµ–
```bash
git clone https://github.com/roclee2692/contextual-retrieval-by-anthropic.git
cd contextual-retrieval-by-anthropic
pip install -r requirements.txt
```

### 2. è¿è¡Œå®éªŒï¼ˆç»Ÿä¸€è„šæœ¬ï¼‰

**æ–¹å¼ A: é£Ÿå ‚å®éªŒ (Phase 1)**
```bash
# ä¸€é”®åˆ‡æ¢é…ç½® + æ„å»ºæ•°æ®åº“ + è¿è¡Œæµ‹è¯•
python run_experiment.py canteen --build --test
```

**æ–¹å¼ B: é˜²æ´ªå®éªŒ (Phase 2)**
```bash
# è¿è¡Œå®Œæ•´ä¸‰ç»„å¯¹æ¯” (Baseline vs CR vs KG)
python scripts/phase2_three_way_comparison.py

# æˆ–è¿è¡Œå•ç‹¬å®éªŒ
python run_experiment.py flood --test  # ä»… CR
python scripts/test_kg_retrieval.py    # ä»… KG
```

**æ‰‹åŠ¨æ¨¡å¼ï¼ˆé«˜çº§ï¼‰**
```bash
# æ­¥éª¤ 1: æ‰‹åŠ¨åˆ‡æ¢é…ç½®
Copy-Item .env.canteen .env  # æˆ– .env.flood

# æ­¥éª¤ 2: æ„å»ºæ•°æ®åº“
python scripts/create_save_db.py

# æ­¥éª¤ 3: è¿è¡Œæµ‹è¯•
python scripts/test_ab_simple.py  # é£Ÿå ‚å®éªŒ
python scripts/run_flood_comparison.py  # é˜²æ´ªå®éªŒ
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
contextual-retrieval-by-anthropic/
â”œâ”€â”€ .env                    # å½“å‰ç”Ÿæ•ˆé…ç½®
â”œâ”€â”€ .env.canteen            # é£Ÿå ‚å®éªŒé…ç½®
â”œâ”€â”€ .env.flood              # é˜²æ´ªå®éªŒé…ç½®
â”œâ”€â”€ data/                   # æ•°æ®é›†
â”œâ”€â”€ src/                    # æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ contextual_retrieval/
â”‚   â”œâ”€â”€ db/                 # å‘é‡/å›¾è°±æ•°æ®åº“å­˜å‚¨
â”‚   â””â”€â”€ tools/
â””â”€â”€ results/                # å®éªŒç»“æœæŠ¥å‘Š
```

---

## ğŸ“§ è”ç³»æ–¹å¼
**ä½œè€…**ï¼šroclee2692  
**GitHub**ï¼š[@roclee2692](https://github.com/roclee2692)

**å¦‚æœæœ¬é¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ª â­ï¸ Starï¼**
