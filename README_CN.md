# ç»“æ„åŒ–æ•°æ®çš„ä¸Šä¸‹æ–‡æ£€ç´¢ï¼šå¯å¤ç°å®éªŒ

**[English](README.md) | [ç®€ä½“ä¸­æ–‡](README_CN.md)**

[![Python 3.11+](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Reproducible](https://img.shields.io/badge/reproducible-yes-green.svg)](https://github.com/roclee2692/contextual-retrieval-by-anthropic)

> **æ ¸å¿ƒå‘ç°**ï¼šåœ¨å¤ç°äº† Anthropic çš„ Contextual Retrieval ç®—æ³•åï¼Œæˆ‘ä»¬å¼•å…¥äº†**å‚ç›´é¢†åŸŸï¼ˆé˜²æ´ªï¼‰çŸ¥è¯†å›¾è°±**è¿›è¡Œå¯¹æ¯”å®éªŒã€‚å‘ç° CR åœ¨ç»“æ„åŒ–æ•°æ®ä¸Šå­˜åœ¨â€œåŒåˆƒå‰‘â€æ•ˆåº”ï¼Œè€ŒçŸ¥è¯†å›¾è°±èƒ½æ˜¾è‘—å¼¥è¡¥å…¶åœ¨é€»è¾‘æ¨ç†ä¸Šçš„çŸ­æ¿ã€‚

---

## ğŸ¯ å®éªŒæ¶æ„

æœ¬é¡¹ç›®å°†ç ”ç©¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ŒåŒ…å« **5 ç»„å¯¹æ¯”å®éªŒ**ï¼Œæ—¨åœ¨å…¨é¢è¯„ä¼° RAG æŠ€æœ¯åœ¨ä¸åŒæ•°æ®å½¢æ€ä¸‹çš„è¡¨ç°ï¼š

### ç¬¬ä¸€é˜¶æ®µï¼šç»“æ„åŒ–åˆ—è¡¨æ•°æ®ï¼ˆé£Ÿå ‚èœå•ï¼‰
> éªŒè¯ CR åœ¨**éè‡ªç„¶è¯­è¨€æ–‡æœ¬**ä¸Šçš„å±€é™æ€§ä¸ä¼˜åŠ¿ã€‚

| å®éªŒç¼–å· | æ–¹æ³• | æ ¸å¿ƒæŠ€æœ¯ | é€‚ç”¨æ•°æ® |
|---|---|---|---|
| **Exp 1** | Baseline RAG | å‘é‡æ£€ç´¢ (bge-small-zh) + BM25 | åˆ—è¡¨ (List) |
| **Exp 2** | CR Enhanced | LLM ç”Ÿæˆä¸Šä¸‹æ–‡å‰ç¼€ + å‘é‡ + BM25 | åˆ—è¡¨ (List) |
| **Exp 3** | Jieba + Simple KG | ç»“å·´åˆ†è¯ + NetworkX ç®€å•å›¾è°± | åˆ—è¡¨ (List) |

### ç¬¬äºŒé˜¶æ®µ:éç»“æ„åŒ–é¢†åŸŸæ•°æ®(é˜²æ´ªé¢„æ¡ˆ)
> éªŒè¯ Baselineã€CR å’Œ KG åœ¨**å‚ç›´é¢†åŸŸå¤æ‚æ–‡æœ¬**ä¸Šçš„æ¨ç†èƒ½åŠ›å¯¹æ¯”ã€‚

| å®éªŒç¼–å· | æ–¹æ³• | æ ¸å¿ƒæŠ€æœ¯ | é€‚ç”¨æ•°æ® |
|---|---|---|---|
| **Exp 4** | Baseline (Flood) | å‘é‡ + BM25(æ— ä¸Šä¸‹æ–‡å¢å¼º) | æ–‡æœ¬ (Text) |
| **Exp 5** | CR (Flood) | ä¸Šä¸‹æ–‡æ£€ç´¢(LLM ç”Ÿæˆä¸Šä¸‹æ–‡å‰ç¼€) | æ–‡æœ¬ (Text) |
| **Exp 6** | Deep KG (Flood) | LlamaIndex çŸ¥è¯†å›¾è°± + å›¾æ¨ç† | æ–‡æœ¬ (Text) |

---

## ğŸ“Š Phase 1: é£Ÿå ‚å®éªŒç»“æœ

> ç»“è®ºï¼šCR åœ¨è§£å†³æ­§ä¹‰ï¼ˆå¦‚â€œå¤©æ´¥åŒ…å­â€æ˜¯åº—åè¿˜æ˜¯èœåï¼‰ä¸Šæå…¶æœ‰æ•ˆï¼ˆä»0%æå‡è‡³100%å‡†ç¡®ç‡ï¼‰ï¼Œä½†åœ¨å¯†é›†åˆ—è¡¨æ•°æ®çš„ç»†èŠ‚æ£€ç´¢ä¸Šåè€Œå¯¼è‡´ä¿¡æ¯ä¸¢å¤±ã€‚

| æŒ‡æ ‡ | å®éªŒä¸€(Baseline) | å®éªŒäºŒ(CR) | å®éªŒä¸‰(ç»“å·´+KG) |
|---|---|---|---|
| **å¹³å‡å“åº”æ—¶é—´** | 12.79ç§’ | 13.64ç§’ | **10.13ç§’** âš¡ |
| **æ··åˆæ£€ç´¢åŠ é€Ÿæ¯”** | 9.9% | 8.5% | **19.9%** |
| **ä»·æ ¼ç±»æŸ¥è¯¢å‡†ç¡®ç‡** | 75% | **100%** âœ… | 100% |

---

## ğŸ†• Phase 2: é˜²æ´ªé¢„æ¡ˆä¸‰ç»„å¯¹æ¯”å®éªŒ(æ–°å¢)

åœ¨ Phase 1 çš„åŸºç¡€ä¸Š,æˆ‘ä»¬åœ¨ **é˜²æ´ªåº”æ€¥é¢„æ¡ˆ** å‚ç›´é¢†åŸŸæ•°æ®ä¸Šè¿›è¡Œäº†å®Œæ•´çš„ä¸‰ç»„å¯¹æ¯”å®éªŒã€‚

*è¯¦ç»†å¯¹æ¯”æŠ¥å‘Šè§ `results/flood_comparison_report.md`*

### å®éªŒè®¾è®¡
| å®éªŒ | è¯´æ˜ | è„šæœ¬ |
|---|---|---|
| **Exp 4: Baseline** | çº¯å‘é‡+BM25æ£€ç´¢(æ— CR) | `run_flood_comparison.py` |
| **Exp 5: CR Enhanced** | å¸¦ä¸Šä¸‹æ–‡å¢å¼ºçš„æ£€ç´¢ | `run_flood_comparison.py` |
| **Exp 6: Deep KG** | çŸ¥è¯†å›¾è°±æ¨ç†æ£€ç´¢ | `create_knowledge_graph.py` + `test_kg_retrieval.py` |

### æ ¸å¿ƒå‘ç°
1.  **CR åœ¨é•¿æ–‡æ¡£ä¸Šçš„æ•ˆæœ**:
    *   åœ¨é˜²æ´ªé¢„æ¡ˆè¿™ç§**æœ‰æ˜ç¡®ä¸Šä¸‹æ–‡çº¿ç´¢**çš„æ–‡æ¡£ä¸­,CR æ˜¾è‘—ä¼˜äº Baselineã€‚
    *   ä¸ Phase 1 é£Ÿå ‚èœå•(åˆ—è¡¨æ•°æ®)å½¢æˆå¯¹æ¯”,éªŒè¯äº† CR å¯¹æ•°æ®ç±»å‹çš„ä¾èµ–æ€§ã€‚

2.  **çŸ¥è¯†å›¾è°±çš„ä¼˜åŠ¿**:
    *   æ„å»ºäº†åŒ…å« **600+ å®ä½“** çš„é˜²æ´ªçŸ¥è¯†ç½‘ç»œã€‚
    *   è§£å†³äº†çº¯å‘é‡æ£€ç´¢æ— æ³•å›ç­”çš„**å¤šè·³æ¨ç†é—®é¢˜**ã€‚
    *   *ä¾‹å­*: "è°è´Ÿè´£æ°´åº“æ¼«åé¢„è­¦?" â†’ KG æ²¿ç€ `æŒ‡æŒ¥éƒ¨ -> èŒè´£ -> é¢„è­¦è§¦å‘` è·¯å¾„ç²¾å‡†å®šä½ã€‚

---

## ğŸ”„ ç³»ç»Ÿæµç¨‹å›¾ (System Pipeline)

```mermaid
graph LR
    A[PDF æ•°æ®] --> B[æ–‡æœ¬åˆ‡ç‰‡]
    B --> C{å¯ç”¨ CR?}
    C -->|æ˜¯| D[LLM ç”Ÿæˆä¸Šä¸‹æ–‡]
    C -->|å¦| E[åŸå§‹åˆ‡ç‰‡]
    D --> F[æ‹¼æ¥ä¸Šä¸‹æ–‡ + åŸæ–‡]
    E --> G[Embedding å‘é‡åŒ–]
    F --> G
    G --> H[å‘é‡æ•°æ®åº“ ChromaDB]
    
    subgraph æ··åˆæ£€ç´¢
    B --> I{å¯ç”¨ç»“å·´?}
    I -->|æ˜¯| J["ä¸­æ–‡åˆ†è¯<br/>(BM25)"]
    I -->|å¦| K[é»˜è®¤åˆ†è¯]
    J --> L[BM25 ç´¢å¼•]
    K --> L
    end

    subgraph "Phase 2: çŸ¥è¯†å›¾è°±"
    B --> M[å®ä½“æŠ½å–]
    M --> N[å›¾è°±æ„å»º Graph Store]
    N --> O[å›¾è°±æ¨ç†æŸ¥è¯¢]
    end
    
    H -.-> P[æœ€ç»ˆæ··åˆæ£€ç´¢]
    L -.-> P
    O -.-> P
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒå‡†å¤‡
- Python 3.11+
- [Ollama](https://ollama.com/download) å·²å®‰è£…
- `gemma3:12b` (é—®ç­”) å’Œ `gemma2:2b` (ä¸Šä¸‹æ–‡ç”Ÿæˆ)

### 1. å®‰è£…ä¾èµ–
```bash
git clone https://github.com/roclee2692/contextual-retrieval-by-anthropic.git
cd contextual-retrieval-by-anthropic
pip install -r requirements.txt
```

### 2. è¿è¡Œå®éªŒï¼ˆç»Ÿä¸€è„šæœ¬ï¼‰

**æ–¹å¼ A: é£Ÿå ‚å®éªŒ (Phase 1)**
```bash
# ä¸€é”®åˆ‡æ¢é…ç½® + æ„å»ºæ•°æ®åº“ + è¿è¡Œæµ‹è¯•
python run_experiment.py canteen --build --test
```

**æ–¹å¼ B: é˜²æ´ªå®éªŒ (Phase 2)**
```bash
# åˆ‡æ¢å¹¶è¿è¡Œå¯¹æ¯”æµ‹è¯•
python run_experiment.py flood --test

# æˆ–æ„å»ºçŸ¥è¯†å›¾è°±ï¼ˆè€—æ—¶è¾ƒé•¿ï¼‰
python scripts/create_knowledge_graph.py
python scripts/test_kg_retrieval.py
```

**æ‰‹åŠ¨æ¨¡å¼ï¼ˆé«˜çº§ï¼‰**
```bash
# æ­¥éª¤ 1: æ‰‹åŠ¨åˆ‡æ¢é…ç½®
Copy-Item .env.canteen .env  # æˆ– .env.flood

# æ­¥éª¤ 2: æ„å»ºæ•°æ®åº“
python scripts/create_save_db.py

# æ­¥éª¤ 3: è¿è¡Œæµ‹è¯•
python scripts/test_ab_simple.py  # é£Ÿå ‚å®éªŒ
python scripts/run_flood_comparison.py  # é˜²æ´ªå®éªŒ
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
contextual-retrieval-by-anthropic/
â”œâ”€â”€ .env                    # å½“å‰ç”Ÿæ•ˆé…ç½®
â”œâ”€â”€ .env.canteen            # é£Ÿå ‚å®éªŒé…ç½®
â”œâ”€â”€ .env.flood              # é˜²æ´ªå®éªŒé…ç½®
â”œâ”€â”€ data/                   # æ•°æ®é›†
â”œâ”€â”€ src/                    # æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ contextual_retrieval/
â”‚   â”œâ”€â”€ db/                 # å‘é‡/å›¾è°±æ•°æ®åº“å­˜å‚¨
â”‚   â””â”€â”€ tools/
â””â”€â”€ results/                # å®éªŒç»“æœæŠ¥å‘Š
```

---

## ğŸ“§ è”ç³»æ–¹å¼
**ä½œè€…**ï¼šroclee2692  
**GitHub**ï¼š[@roclee2692](https://github.com/roclee2692)

**å¦‚æœæœ¬é¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ª â­ï¸ Starï¼**
