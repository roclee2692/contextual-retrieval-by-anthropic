# 上下文检索（CR）算法效果分析报告

## 执行时间：2026年1月14日  

---

## 一、实验对比概况

| 指标 | RAG_Chunked（基准） | CR_Prefixed（增强） | 差异 |
|------|-------------------|-------------------|------|
| **数据来源** | 原始PDF（无上下文前缀） | 经过上下文预处理的PDF | - |
| **总问题数** | 20 | 20 | - |
| **方法A成功率** | 100% (20/20) | 100% (20/20) | ✓ 持平 |
| **方法B成功率** | 100% (20/20) | 100% (20/20) | ✓ 持平 |
| **平均响应时间(A)** | 11.34s | 12.48s | ↑ +1.14s (+10.1%) |
| **平均响应时间(B)** | 10.91s | 11.59s | ↑ +0.68s (+6.2%) |

---

## 二、关键问题对比分析（包子类问题）

### Q3: 哪些窗口提供包子类食品？

**RAG_Chunked（基准）：**
- 方法A回答详细，列举了窗口42的多种包子类型（鲜肉包、玉米鲜肉包、香菇鲜肉包等12种）
- 准确性：⭐⭐⭐⭐⭐ 完整列表

**CR_Prefixed（增强）：**
- 方法A回答简洁："窗口42提供香港九龙包，窗口21提供天津包子"
- 准确性：⭐⭐⭐⭐ 正确但不完整（缺少详细列表）
- **变化：回答质量下降** ❌

---

### Q8: 天津包子档口在几号窗口？

**RAG_Chunked（基准）：**
- 方法A: "The Tianjin baozi stall is located at window number 42" ❌ **错误！**
- 方法B: 同上 ❌ **错误！**
- 准确性：完全错误，应该是21号窗口

**CR_Prefixed（增强）：**
- 方法A: "天津包子在21号窗口" ✅ **正确！**
- 方法B: "天津包子在21号窗口" ✅ **正确！**
- 准确性：⭐⭐⭐⭐⭐ 完全正确
- **变化：回答质量提升** ✅

---

### Q15: 哪个档口的包子种类最多？

**RAG_Chunked（基准）：**
- 方法A: 回答详细列表（12种包子）
- 准确性：⭐⭐⭐⭐⭐

**CR_Prefixed（增强）：**
- 方法A: 仅回答"一号餐厅的包子种类最多"
- 准确性：⭐⭐⭐⭐ 正确但缺少细节
- **变化：信息内容减少** ❌

---

## 三、关键问题对比分析（其他问题）

### Q1: 一号餐厅有哪些窗口或档口？

**RAG_Chunked（基准）：**
- 方法A: 提及"Window 14"
- 方法B: 更详细"Window 14"和"stall 13/14"

**CR_Prefixed（增强）：**
- 方法A: **无法回答** "This information pertains to the 二号餐厅"
- 方法B: 明确说明数据不匹配
- **变化：检索能力严重下降** ❌❌❌

---

### Q16: 一号餐厅有哪些2元的粥？

**RAG_Chunked（基准）：**
- 方法A: 列举6种粥品（小米南瓜粥、清火绿豆粥等）
- 准确性：⭐⭐⭐⭐

**CR_Prefixed（增强）：**
- 方法A: 列举16种粥品（详细列表）
- 准确性：⭐⭐⭐⭐⭐ 更完整
- **变化：信息更详尽** ✅

---

## 四、定量分析

### 准确性评分（满分100）

#### RAG_Chunked（基准）
| 问题 | 准确度 | 注释 |
|------|--------|------|
| Q1 | 60 | 信息不完整 |
| Q3 | 100 | 完整列表 |
| Q7 | 100 | 正确位置 |
| **Q8** | **0** | **❌ 错位到42号** |
| Q15 | 100 | 详细列表 |
| Q16 | 70 | 缺少部分粥品 |
| **平均（包子相关）** | **67** | - |

#### CR_Prefixed（增强）
| 问题 | 准确度 | 注释 |
|------|--------|------|
| Q1 | **0** | ❌ 无法回答 |
| Q3 | 70 | 信息缺失 |
| Q7 | 100 | 正确位置 |
| **Q8** | **100** | **✅ 正确的21号** |
| Q15 | 85 | 正确但缺细节 |
| Q16 | 95 | 更完整 |
| **平均（包子相关）** | **76** | - |

---

## 五、关键发现

### 🎯 好消息（CR_Prefixed的优势）：
1. **Q8显著改善**：正确定位天津包子到21号窗口（RAG_Chunked误为42号）
2. **Q16更详尽**：列出16种2元粥品，而基准只有6种
3. **整体包子问题准确率**：从67→76，**提升+9分**

### ⚠️ 问题（CR_Prefixed的劣势）：
1. **Q1完全失效**：无法识别一号餐厅数据（准确度从60→0）
2. **Q3信息减少**：从"12种包子列表"简化为"2个窗口名"
3. **Q15细节减少**：丢失具体包子类型列表
4. **响应时间增加**：平均慢10%（可能是LLM处理更长的上下文）

---

## 六、根本原因分析

### 为什么Q8改善，但Q1恶化？

**假说**：CR_Prefixed PDF经过LLM预处理生成上下文前缀，这导致：
- **增强**：某些信息获得更好的语义表示（Q8中的天津包子→21号的关联强化）
- **损失**：某些信息（如一号餐厅的档口列表）可能在预处理时被标注为"民族风味"而淡化

### 数据一致性问题

CR_Prefixed PDF中关于**一号餐厅的内容可能被严重压缩或重新组织**，导致向量检索时无法准确召回一号餐厅的数据。

---

## 七、结论

### ✅ 算法有效性验证

| 指标 | 结论 |
|------|------|
| 是否改善部分查询 | ✅ **是**（Q8从0%→100%） |
| 是否全面改善 | ❌ **否**（Q1从60%→0%） |
| 信息量变化 | 🔄 **不一致**（增加16种粥，减少12种包子） |
| 数据匹配度 | ⚠️ **存在问题**（一号餐厅信息丢失） |

### 📊 最终评分

| 维度 | 评分 |
|------|------|
| **包子类问题改进** | 6/10（改善Q8，恶化Q1和Q3） |
| **整体检索能力** | 5/10（破坏了一号餐厅的检索） |
| **算法可行性** | 6/10（有潜力，但需要优化） |

---

## 八、建议

### 短期
1. **检查CR_Prefixed PDF的生成过程**：确保一号餐厅信息被正确保留
2. **调查Q8为什么改善**：学习什么样的上下文前缀有助于改善特定问题
3. **验证数据完整性**：确保两个PDF都包含完整的一号、二号、民族餐厅数据

### 中期
1. **选择性应用CR**：仅对确定能改善的查询类型应用上下文前缀
2. **优化上下文生成**：避免破坏原有的数据结构和信息完整性
3. **A/B测试更多样本**：扩大测试规模以获得统计显著性

### 长期
1. **多语言优化**：CR算法在Anthropic原始论文中基于英文数据，中文适配需要特别考虑
2. **混合策略**：保留BM25用于精确匹配（如窗口号），CR用于语义理解

---

## 九、总结

在纯向量检索对比中，**Contextual Retrieval在中文食堂菜单场景下表现不一致**：
- **最佳案例**：Q8天津包子定位准确度提升100%
- **最坏案例**：Q1一号餐厅无法检索（准确度下降60%）
- **平均结果**：包子相关问题准确度提升9%，但伴随整体检索能力退化

**结论**：该CR方案需要进一步调试数据预处理流程，特别是确保所有canteen的信息完整性，才能成为生产环境推荐方案。
